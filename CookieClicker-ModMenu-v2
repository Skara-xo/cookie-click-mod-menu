// ==UserScript==
// @name         Cookie Clicker - Mod Menu Complet
// @namespace    http://tampermonkey.net/
// @version      3.1
// @description  AutoClick, AutoReindeer, AutoGolden (30s, sauf colère), Mute/Expand avec raccourcis clavier, UI compacte et draggable (AutoGolden ON par défaut)
// @author
// @match        *://orteil.dashnet.org/cookieclicker/*
// @grant        none
// @license      MIT
// ==/UserScript==

(function () {
    'use strict';

    const waitForGame = setInterval(() => {
        if (typeof Game !== 'undefined' && Game.ready) {
            clearInterval(waitForGame);
            initModMenu();
            initKeyboardShortcuts();
            console.log("[Mod Menu] Chargé avec raccourcis Q/W/X/C/V/E/A/Z");
        }
    }, 500);

    function initModMenu() {
        const menu = document.createElement('div');
        menu.id = 'hackMenu';
        Object.assign(menu.style, {
            position: 'fixed',
            top: '15px',
            left: '50%',
            transform: 'translateX(-50%)',
            zIndex: 10000,
            background: 'rgba(0, 0, 0, 0.85)',
            color: '#fff',
            padding: '6px 12px',
            borderRadius: '10px',
            fontFamily: 'Arial, sans-serif',
            fontSize: '13px',
            boxShadow: '0 0 8px #000',
            display: 'flex',
            alignItems: 'center',
            gap: '10px',
            userSelect: 'none',
            cursor: 'default'
        });

        const title = document.createElement('div');
        title.textContent = 'Mod Menu';
        title.style.fontWeight = 'bold';
        title.style.marginRight = '10px';
        title.style.cursor = 'pointer';
        menu.appendChild(title);

        const createButton = (emoji, label, titleText, onclick, id) => {
            const btn = document.createElement('div');
            btn.innerHTML = `<span class="emoji">${emoji}</span> <span class="label">${label}</span>`;
            btn.title = titleText;
            btn.id = id;
            Object.assign(btn.style, {
                cursor: 'pointer',
                padding: '4px 10px',
                border: '1px solid #ccc',
                borderRadius: '6px',
                background: '#333',
                color: '#fff',
                transition: 'background 0.2s, border 0.2s',
                display: 'flex',
                alignItems: 'center',
                gap: '4px'
            });

            btn.onmouseenter = () => {
                if (btn.classList.contains('active')) btn.style.background = 'green';
                else btn.style.background = '#555';
            };
            btn.onmouseleave = () => {
                if (btn.classList.contains('active')) btn.style.background = 'green';
                else btn.style.background = '#333';
            };
            btn.onclick = () => {
                PlaySound('snd/tick.mp3');
                onclick();
            };
            return btn;
        };

        let autoclickerActive = false;
        let interval = null;
        const btnAuto = createButton('🖱️', 'AutoClick', 'Clic Auto', () => {
            autoclickerActive = !autoclickerActive;
            btnAuto.classList.toggle('active', autoclickerActive);
            updateButtonStyle(btnAuto, autoclickerActive);
            if (autoclickerActive) interval = setInterval(() => Game.ClickCookie(), 10);
            else clearInterval(interval);
        }, 'btnAuto');

        let autoreindeerActive = true;
        const btnAutoReindeer = createButton('🎅', 'AutoReindeer', 'Clic Auto Renne', () => {
            autoreindeerActive = !autoreindeerActive;
            btnAutoReindeer.classList.toggle('active', autoreindeerActive);
            updateButtonStyle(btnAutoReindeer, autoreindeerActive);
        }, 'btnAutoReindeer');

        let autogoldenActive = false;
        const goldenSeen = new Map();
        const btnAutoGolden = createButton('🍪', 'AutoGolden', 'Auto clic cookie doré après 30s (sauf colère)', () => {
            autogoldenActive = !autogoldenActive;
            btnAutoGolden.classList.toggle('active', autogoldenActive);
            updateButtonStyle(btnAutoGolden, autogoldenActive);
        }, 'btnAutoGolden');

        let buildingsMuted = false;
        const btnMute = createButton('↕️', 'Expand', 'Réduire/agrandir tous les bâtiments', () => {
            buildingsMuted = !buildingsMuted;
            for (let i in Game.ObjectsById) {
                Game.ObjectsById[i].mute(buildingsMuted);
            }
            btnMute.classList.toggle('active', buildingsMuted);
            updateButtonStyle(btnMute, buildingsMuted);
        }, 'btnMute');

        const btnSave = createButton('💾', 'Save', 'Sauvegarder', () => Game.toSave = true);
        const btnExport = createButton('📤', 'Export', 'Exporter sauvegarde', () => Game.ExportSave());

        const buttons = [btnAuto, btnAutoReindeer, btnAutoGolden, btnMute, btnSave, btnExport];
        buttons.forEach(btn => menu.appendChild(btn));
        document.body.appendChild(menu);

        let isCompact = false;
        function toggleCompactMode(forceState = null) {
            isCompact = forceState !== null ? forceState : !isCompact;
            document.querySelectorAll('#hackMenu .label').forEach(label => {
                label.style.display = isCompact ? 'none' : 'inline';
            });
        }

        setTimeout(() => toggleCompactMode(true), 100);
        title.addEventListener('click', () => toggleCompactMode());

        // Rendre le menu draggable
        let offsetX = 0, offsetY = 0, dragging = false;
        title.addEventListener('mousedown', function (e) {
            dragging = true;
            offsetX = e.clientX - menu.getBoundingClientRect().left;
            offsetY = e.clientY - menu.getBoundingClientRect().top;
            document.body.style.userSelect = 'none';
            title.style.cursor = 'grabbing';
        });
        document.addEventListener('mousemove', function (e) {
            if (dragging) {
                menu.style.left = (e.clientX - offsetX) + 'px';
                menu.style.top = (e.clientY - offsetY) + 'px';
                menu.style.transform = 'none';
            }
        });
        document.addEventListener('mouseup', function () {
            if (dragging) {
                dragging = false;
                document.body.style.userSelect = '';
                title.style.cursor = 'grab';
            }
        });

        function updateButtonStyle(btn, active) {
            btn.style.background = active ? 'green' : '#333';
            btn.style.borderColor = active ? 'lime' : '#ccc';
        }

        // Auto boucle
        setInterval(() => {
            if (!autoreindeerActive || Game.season !== 'christmas') return;
            Game.shimmers.forEach(shimmer => {
                if (shimmer.type === 'reindeer' && !shimmer.clickedByAuto) {
                    shimmer.clickedByAuto = true;
                    setTimeout(() => shimmer.pop(), 500);
                }
            });
        }, 500);

        setInterval(() => {
            if (!autogoldenActive) return;
            Game.shimmers.forEach(shimmer => {
                if (shimmer.type === 'golden' && !shimmer.clickedByAuto && shimmer.spawnLead && !shimmer.wrath) {
                    const id = shimmer.id || shimmer.l;
                    if (!goldenSeen.has(id)) goldenSeen.set(id, Date.now());
                    if (Date.now() - goldenSeen.get(id) >= 30000) {
                        shimmer.clickedByAuto = true;
                        shimmer.pop();
                        goldenSeen.delete(id);
                    }
                }
            });
        }, 1000);

        // Activation auto par défaut
        setTimeout(() => {
            btnAuto.click();
            btnAutoGolden.click();
            updateButtonStyle(btnAuto, autoclickerActive);
            updateButtonStyle(btnAutoReindeer, autoreindeerActive);
            updateButtonStyle(btnAutoGolden, autogoldenActive);
        }, 500);
    }

    function initKeyboardShortcuts() {
        document.addEventListener('keydown', (e) => {
            if (e.repeat) return;
            const key = e.key.toLowerCase();
            console.log(`[Raccourci] Touche pressée : ${key}`);

            switch (key) {
                case 'q': {
                    const buy = document.getElementById('storeBulkBuy');
                    const sell = document.getElementById('storeBulkSell');
                    if (buy?.classList.contains('selected')) {
                        sell?.click();
                        console.log("[Q] → 💰 Vendre");
                    } else {
                        buy?.click();
                        console.log("[Q] → 🛒 Acheter");
                    }
                    break;
                }
                case 'w':
                    document.getElementById('storeBulk1')?.click();
                    console.log("[W] → Quantité : 1");
                    break;
                case 'x':
                    document.getElementById('storeBulk10')?.click();
                    console.log("[X] → Quantité : 10");
                    break;
                case 'c':
                    document.getElementById('storeBulk100')?.click();
                    console.log("[C] → Quantité : 100");
                    break;
                case 'v':
                    document.getElementById('storeBulkMax')?.click();
                    console.log("[V] → Quantité : Max");
                    break;
                case 'e':
                    document.getElementById('btnAutoGolden')?.click();
                    console.log("[E] → AutoGolden toggle");
                    break;
                case 'a':
                    document.getElementById('btnAuto')?.click();
                    console.log("[A] → AutoClick toggle");
                    break;
                case 'z': {
                    const muteBtn = document.getElementById('btnMute');
                    muteBtn?.click();
                    console.log("[Z] → Mute/Expand toggle");
                    break;
                }
                // Cas spéciaux AZERTY (optionnel)
                case '&': Game.ObjectsById[2]?.mute(); break;
                case 'é': Game.ObjectsById[5]?.mute(); break;
                case '"': Game.ObjectsById[6]?.mute(); break;
                case '\'': Game.ObjectsById[7]?.mute(); break;
            }
        });
    }

})();
